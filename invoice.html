<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archer's Timesheet & Invoice System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>
    <div class="nav-buttons">
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit.html" class="nav-button" data-tooltip="Black Iron Edit"><i class="fas fa-edit"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit3.html" class="nav-button" data-tooltip="Black Iron v1"><i class="fas fa-file-alt"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironcal2.html" class="nav-button" data-tooltip="Calculator"><i class="fas fa-calculator"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Uploadcsv.html" class="nav-button" data-tooltip="Upload CSV"><i class="fas fa-upload"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Timesheet.html" class="nav-button" data-tooltip="Timesheet"><i class="fas fa-clock"></i></a>
    </div>

    <h1>Archer's Timesheet & Invoice System</h1>

    <div id="form">
        <label>Employee Name: <input type="text" id="employee" value="Lucas"></label>
        <label>Date: <input type="date" id="sessionDate"></label>
        <h2>Add / Edit Job Entry</h2>
        <label>Job Type: <select id="jobType">
            <option>Custom</option>
            <option>Compressor Replacement</option>
            <option>Refrigerant Leak Repair</option>
            <option>Furnace Installation</option>
            <option>Air Conditioner Maintenance</option>
            <option>Duct Cleaning</option>
            <option>Thermostat Replacement</option>
            <option>Boiler Repair</option>
            <option>Heat Pump Installation</option>
            <option>Ventilation System Cleaning</option>
            <option>Radiator Replacement</option>
            <option>Air Handler Repair</option>
            <option>Evaporator Coil Cleaning</option>
            <option>Condenser Unit Replacement</option>
            <option>Gas Line Installation</option>
            <option>Underground Gas Line Install</option>
            <option>Pool Heater Gas Line</option>
            <option>Gas Line Pressure Testing</option>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <script src="scripts/main.js"></script>

        // === FORM ===
        const jobTypeSelect = document.getElementById('jobType');
        jobTypeSelect.addEventListener('change', function() {
            const descTextarea = document.getElementById('description');
            if (this.value !== 'Custom') {
                document.getElementById('jobName').value = this.value;
                const template = jobTemplates[this.value];
                if (template && template.steps) {
                    // Brief description: Join first 5 steps with newlines for readability
                    const briefSteps = template.steps.slice(0, 5).join('\n- ');
                    descTextarea.value = `- ${briefSteps}`;
                }
            } else {
                // Clear description for Custom
                descTextarea.value = '';
            }
        });

        document.getElementById('actionButton').onclick = () => {
            const idx = +document.getElementById('editIndex').value;
            const date = document.getElementById('sessionDate').value;
            let job = document.getElementById('jobName').value.trim();
            const addr = document.getElementById('address').value.trim();
            const tIn = document.getElementById('timeIn').value;
            const tOut = document.getElementById('timeOut').value;
            const desc = document.getElementById('description').value.trim();

            if (!date) return alert('Select a date');
            if (!job) return alert('Enter job name');
            if (timeToDecimal(tOut) === timeToDecimal(tIn)) return alert('Time In and Time Out cannot be the same');

            const entry = {dateStr: date, jobName: job, address: addr, timeIn: tIn, timeOut: tOut, description: desc};

            if (idx === -1) entries.push(entry);
            else entries[idx] = entry;

            if (addr && !addressHistory.includes(addr)) {
                addressHistory.unshift(addr);
                if (addressHistory.length > 50) addressHistory.pop();
            }

            renderTable();
            clearForm();
        };

        function clearForm() {
            document.getElementById('jobType').value = 'Custom';
            document.getElementById('jobName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('description').value = '';
            document.getElementById('editIndex').value = -1;
            document.getElementById('actionButton').textContent = 'Add Entry';
            document.getElementById('cancelButton').style.display = 'none';
            if (entries.length) {
                const last = entries[entries.length-1];
                document.getElementById('timeIn').value = last.timeOut;
                document.getElementById('timeOut').value = getNextTime(last.timeOut);
            }
        }
        document.getElementById('cancelButton').onclick = clearForm;

        document.getElementById('copyLast').onclick = () => {
            if (!entries.length) return alert('No previous job');
            const l = entries[entries.length-1];
            document.getElementById('jobType').value = 'Custom';
            document.getElementById('jobName').value = l.jobName;
            document.getElementById('address').value = l.address || '';
            document.getElementById('description').value = l.description || '';
            document.getElementById('timeIn').value = l.timeOut;
            document.getElementById('timeOut').value = getNextTime(l.timeOut);
        };

        document.getElementById('clearAllButton').onclick = () => {
            if (confirm('Clear ALL entries?')) { 
                entries = []; 
                currentTimesheetId = null;
                renderTable(); 
                clearForm(); 
            }
        };

        // === TIMESHEET SAVE/LOAD ===
        document.getElementById('saveTimesheet').onclick = () => {
            const name = prompt('Timesheet Name (e.g., "Lucas - 12/08/2025"):', `${document.getElementById('employee').value} - ${formatDate(document.getElementById('sessionDate').value)}`);
            if (!name || entries.length === 0) return alert('Enter a name and add entries first');
            const id = Date.now().toString();
            const ts = {
                id: id,
                name: name,
                data: {
                    employee: document.getElementById('employee').value,
                    date: document.getElementById('sessionDate').value,
                    entries: [...entries]
                },
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            };
            if (currentTimesheetId === null) {
                savedTimesheets.unshift(ts);
                if (savedTimesheets.length > 50) savedTimesheets.pop();
            } else {
                // Update existing
                const existing = savedTimesheets.find(t => t.id === currentTimesheetId);
                if (existing) {
                    existing.data = ts.data;
                    existing.name = name;
                    existing.modified = ts.modified;
                }
            }
            currentTimesheetId = id;
            saveData();
            alert('Timesheet saved!');
        };

        document.getElementById('loadTimesheet').onclick = () => {
            const modal = document.getElementById('timesheetModal');
            const list = document.getElementById('savedTimesheets');
            list.innerHTML = '';
            if (savedTimesheets.length === 0) {
                list.innerHTML = '<div class="timesheet-item">No saved timesheets</div>';
            } else {
                savedTimesheets.forEach(ts => {
                    const div = document.createElement('div');
                    div.className = 'timesheet-item';
                    div.innerHTML = `<strong>${ts.name}</strong><br><small>Modified: ${new Date(ts.modified).toLocaleDateString()}</small>`;
                    div.onclick = () => loadTimesheet(ts.id);
                    list.appendChild(div);
                });
            }
            modal.style.display = 'flex';
        };

        document.getElementById('closeTimesheetModal').onclick = () => {
            document.getElementById('timesheetModal').style.display = 'none';
        };

        // === EXCEL EXPORT ===
        document.getElementById('generateExcel').onclick = () => {
            document.getElementById('loading').style.display = 'block';
            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    const data = [
                        [`Timesheet - ${document.getElementById('employee').value}`, `Date: ${formatDate(document.getElementById('sessionDate').value)}`],
                        [], 
                        ['Job Name', 'Address', 'Time In', 'Time Out', 'Hours', 'Description']
                    ];
                    let totalDec = 0;
                    entries.forEach(e => {
                        const dur = timeToDecimal(e.timeOut) >= timeToDecimal(e.timeIn) 
                            ? timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn)
                            : timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn) + 24;
                        totalDec += dur;
                        data.push([e.jobName, e.address || '', to12hr(e.timeIn), to12hr(e.timeOut), formatHours(dur), e.description || '']);
                    });
                    const {h, m} = decimalToHM(totalDec);
                    data.push([]); data.push(['TOTAL', '', '', '', `${h}:${m.toString().padStart(2,'0')}`, '']);
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch:20},{wch:30},{wch:14},{wch:14},{wch:10},{wch:40}];
                    XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
                    const filename = currentTimesheetId ? savedTimesheets.find(t => t.id === currentTimesheetId).name : `${document.getElementById('employee').value}_Timesheet_${document.getElementById('sessionDate').value}`;
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                } catch(e) {alert('Export failed')}
                document.getElementById('loading').style.display = 'none';
            }, 100);
        };

        // === QuickBooks IIF Export ===
        document.getElementById('exportQuickBooks').onclick = () => {
            const rate = prompt('Enter hourly rate for QuickBooks export:', '100');
            if (!rate || isNaN(rate)) return alert('Invalid rate');

            let iif = "!TRNS\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tDOCNUM\tMEMO\n";
            iif += "!SPL\tTRNSTYPE\tDATE\tACCNT\tNAME\tAMOUNT\tINVITEM\tQNTY\tPRICE\tMEMO\n";
            iif += "!ENDTRNS\n";

            entries.forEach((e, i) => {
                const dur = timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn); // Assume no overnight for IIF simplicity
                const amount = (dur * parseFloat(rate)).toFixed(2);
                const customer = e.address || 'Customer';
                const memo = e.description || '';

                iif += `TRNS\tINVOICE\t${formatDate(e.dateStr)}\tAccounts Receivable\t${customer}\t${amount}\tINV${i+1}\t${memo}\n`;
                iif += `SPL\tINVOICE\t${formatDate(e.dateStr)}\tService Income\t\t-${amount}\t${e.jobName}\t${dur.toFixed(2)}\t${rate}\t${memo}\n`;
                iif += "ENDTRNS\n";
            });

            const blob = new Blob([iif], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invoices.iif';
            a.click();
        };

        // === MULTI-JOB INVOICE ===
        document.getElementById('generateMultiInvoice').onclick = () => openInvoiceEditor(-1); // -1 for multi

        // === INVOICE EDITOR ===
        const invoiceModal = document.getElementById('invoiceModal');
        const invoiceItems = document.getElementById('invoiceItems');
        document.getElementById('closeModal').onclick = () => invoiceModal.style.display = 'none';
        document.getElementById('addLine').onclick = () => addInvoiceLine();
        document.getElementById('hourlyRate').addEventListener('input', updateTotals);

        function openInvoiceEditor(index) {
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('hourlyRate').value = 100;

            invoiceItems.innerHTML = '';
            if (index === -1) { // Multi-job
                entries.forEach(e => {
                    applyTemplateIfAny(e);
                });
            } else { // Single job
                const e = entries[index];
                document.getElementById('clientAddress').value = e.address || '';
                applyTemplateIfAny(e);
            }
            updateTotals();
            invoiceModal.style.display = 'flex';
        }

        function applyTemplateIfAny(e) {
            let laborOpts = {isLabor: true, job: e};
            if (jobTemplates[e.jobName]) {
                const template = jobTemplates[e.jobName];
                const stepsDesc = template.steps.join('\n- ');
                laborOpts.desc = `${e.jobName} (${to12hr(e.timeIn)} - ${to12hr(e.timeOut)}):\n- ${stepsDesc}\n${e.description || ''}`;
                addInvoiceLine(laborOpts);
                template.items.forEach(item => {
                    addInvoiceLine(item);
                });
            } else {
                addInvoiceLine(laborOpts);
            }
        }

        function addInvoiceLine(opts = {}) {
            const isLabor = opts.isLabor || false;
            const job = opts.job || null;
            const category = opts.category || (isLabor ? 'Labor' : 'Parts');
            const qty = opts.qty !== undefined ? opts.qty : (isLabor ? timeToDecimal(job.timeOut) - timeToDecimal(job.timeIn) : 1);
            const desc = opts.desc || (isLabor ? `${job.jobName} (${to12hr(job.timeIn)} - ${to12hr(job.timeOut)}): ${job.description || ''}` : '');
            const price = opts.price !== undefined ? opts.price : (isLabor ? document.getElementById('hourlyRate').value : '');
            const unit = opts.unit || (isLabor ? 'hr' : '');

            const line = document.createElement('div');
            line.className = 'invoice-line';
            line.innerHTML = `
                <select class="category">
                    <option>Labor</option>
                    <option>Parts</option>
                    <option>Materials</option>
                    <option>Other</option>
                </select>
                <input type="number" class="qty" placeholder="Qty" value="${qty.toFixed(2)}">
                <div style="position:relative;">
                    <input type="text" class="desc" placeholder="Description" value="${desc}">
                    <button type="button" class="history-btn task-history-btn"><i class="fas fa-history"></i></button>
                    <div class="taskHistory"></div>
                </div>
                <input type="number" class="price" placeholder="Price" value="${price}">
                <input type="text" class="unit" placeholder="Unit" value="${unit}">
                <input type="number" class="amount" placeholder="Amount" readonly>
                <button class="removeLine">Remove</button>
            `;
            invoiceItems.appendChild(line);

            line.querySelector('.category').value = category;

            // Task history (filter by category)
            const categorySelect = line.querySelector('.category');
            const descInput = line.querySelector('.desc');
            const taskDropdown = line.querySelector('.taskHistory');
            const taskBtn = line.querySelector('.task-history-btn');
            function showTaskHistory(filter = '') {
                const category = categorySelect.value;
                taskDropdown.innerHTML = '';
                const filteredHistory = taskHistory.filter(t => t.category === category);
                const list = filter ? filteredHistory.filter(t => t.task.toLowerCase().includes(filter.toLowerCase())) : filteredHistory;
                if (list.length === 0) {
                    taskDropdown.innerHTML = '<div class="history-item">No tasks found</div>';
                } else {
                    list.forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.textContent = t.task;
                        div.onclick = () => { descInput.value = t.task; taskDropdown.style.display = 'none'; };
                        taskDropdown.appendChild(div);
                    });
                }
                taskDropdown.style.display = 'block';
            }
            descInput.addEventListener('input', () => showTaskHistory(descInput.value));
            descInput.addEventListener('focus', () => showTaskHistory());
            taskBtn.onclick = () => showTaskHistory();
            categorySelect.addEventListener('change', () => showTaskHistory(descInput.value));
            document.addEventListener('click', e => {
                if (!descInput.contains(e.target) && !taskBtn.contains(e.target) && !taskDropdown.contains(e.target)) taskDropdown.style.display = 'none';
            });

            line.querySelector('.qty').addEventListener('input', updateTotals);
            line.querySelector('.price').addEventListener('input', updateTotals);
            line.querySelector('.removeLine').onclick = () => { line.remove(); updateTotals(); };

            updateTotals();
        }

        function updateTotals() {
            let subtotal = 0;
            invoiceItems.querySelectorAll('.invoice-line').forEach(line => {
                const qty = parseFloat(line.querySelector('.qty').value) || 0;
                const price = parseFloat(line.querySelector('.price').value) || 0;
                const amount = qty * price;
                line.querySelector('.amount').value = amount.toFixed(2);
                subtotal += amount;
            });
            const hst = (subtotal * 0.13).toFixed(2);
            const total = (subtotal + parseFloat(hst)).toFixed(2);
            document.getElementById('invoiceTotals').innerHTML = `
                Subtotal: $${subtotal.toFixed(2)}<br>
                HST (13%): $${hst}<br>
                Total: $${total}
            `;
        }

        // === GENERATE PDF ===
        document.getElementById('saveInvoice').onclick = () => {
            document.getElementById('loading').style.display = 'block';

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Logo
            doc.setFillColor(0, 0, 0);
            doc.circle(20, 20, 10, 'F');
            doc.setDrawColor(255, 255, 255);
            doc.setLineWidth(2);
            doc.line(10, 20, 30, 20); // Arrow
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.text("A", 16, 25);
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(24);
            doc.text("ARCHER'S EQUIPMENT REPAIR", 40, 25);

            // Company info
            doc.setFontSize(10);
            doc.text("Archer's Equipment Repair Ltd.", 140, 10);
            doc.text("TSSA #/ 000394614", 140, 15);
            doc.text("HST #: 900518869RT0001", 140, 20);
            doc.text("Phone Number: 519-383-9654", 140, 25);

            // Invoice title
            doc.setFontSize(20);
            doc.text("INVOICE", 160, 35);

            // Client fields
            doc.setFontSize(12);
            doc.text("DATE: " + formatDate(document.getElementById('sessionDate').value), 10, 45);
            doc.text("NAME: " + document.getElementById('clientName').value, 10, 55);
            doc.text("PHONE: " + document.getElementById('clientPhone').value, 10, 65);
            doc.text("EMAIL: " + document.getElementById('clientEmail').value, 10, 75);
            doc.text("ADDRESS: " + document.getElementById('clientAddress').value, 10, 85);

            // Table
            const tableData = [];
            invoiceItems.querySelectorAll('.invoice-line').forEach(line => {
                tableData.push([
                    line.querySelector('.qty').value,
                    line.querySelector('.desc').value,
                    line.querySelector('.price').value,
                    line.querySelector('.unit').value,
                    line.querySelector('.amount').value
                ]);
            });
            doc.autoTable({
                startY: 95,
                head: [['QUANTITY', 'DESCRIPTION', 'PRICE', 'UNIT', 'AMOUNT']],
                body: tableData,
                theme: 'grid',
                headStyles: {fillColor: [211, 211, 211], textColor: [0, 0, 0]},
                styles: {cellPadding: 5, fontSize: 10, overflow: 'linebreak'},
                columnStyles: {0: {cellWidth: 20}, 1: {cellWidth: 80}, 2: {cellWidth: 20}, 3: {cellWidth: 20}, 4: {cellWidth: 30}},
            });

            // Totals
            const finalY = doc.lastAutoTable.finalY + 10;
            const subtotal = Array.from(invoiceItems.querySelectorAll('.amount')).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2);
            const hst = (parseFloat(subtotal) * 0.13).toFixed(2);
            const total = (parseFloat(subtotal) + parseFloat(hst)).toFixed(2);
            doc.text("HST: $" + hst, 150, finalY);
            doc.text("TOTAL: $" + total, 150, finalY + 10);

            // Footer
            doc.setFontSize(8);
            doc.text("e-transfer accepted at Jason@archerser.ca", 105, 280, {align: 'center'});

            const filename = document.getElementById('clientName').value || 'Invoice';
            doc.save(`${filename}_${formatDate(document.getElementById('sessionDate').value)}.pdf`);

            // Save new tasks with category
            invoiceItems.querySelectorAll('.invoice-line').forEach(line => {
                const category = line.querySelector('.category').value;
                const task = line.querySelector('.desc').value.trim();
                if (task && !taskHistory.some(t => t.category === category && t.task === task)) {
                    taskHistory.push({category, task});
                    if (taskHistory.length > 100) taskHistory.shift();
                }
            });
            saveData();

            invoiceModal.style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        };

        // Ctrl+Enter shortcut
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter')
                document.getElementById('actionButton').click();
        });

        // Init
        loadData();
        clearForm();
    </script>
</body>
</html>
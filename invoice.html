<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archer's Timesheet & Invoice System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles/styles.css">
</head>
<body>
    <div class="nav-buttons">
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit.html" class="nav-button" data-tooltip="Black Iron Edit"><i class="fas fa-edit"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit3.html" class="nav-button" data-tooltip="Black Iron v1"><i class="fas fa-file-alt"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironcal2.html" class="nav-button" data-tooltip="Calculator"><i class="fas fa-calculator"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Uploadcsv.html" class="nav-button" data-tooltip="Upload CSV"><i class="fas fa-upload"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Timesheet.html" class="nav-button" data-tooltip="Timesheet"><i class="fas fa-clock"></i></a>
    </div>

    <h1>Archer's Timesheet & Invoice System</h1>

    <div id="form">
        <label>Employee Name: <input type="text" id="employee" value="Lucas"></label>
        <label>Date: <input type="date" id="sessionDate"></label>
        <h2>Add / Edit Job Entry</h2>
        <label>Job Type: <select id="jobType">
            <option>Custom</option>
            <option>Compressor Replacement</option>
            <option>Refrigerant Leak Repair</option>
            <option>Furnace Installation</option>
            <option>Air Conditioner Maintenance</option>
            <option>Duct Cleaning</option>
            <option>Thermostat Replacement</option>
            <option>Boiler Repair</option>
            <option>Heat Pump Installation</option>
            <option>Ventilation System Cleaning</option>
            <option>Radiator Replacement</option>
            <option>Air Handler Repair</option>
            <option>Evaporator Coil Cleaning</option>
            <option>Condenser Unit Replacement</option>
            <option>Gas Line Installation</option>
            <option>Underground Gas Line Install</option>
            <option>Pool Heater Gas Line</option>
            <option>Gas Line Pressure Testing</option>

        // === FORM ===
        const jobTypeSelect = document.getElementById('jobType');
        jobTypeSelect.addEventListener('change', function() {
            const descTextarea = document.getElementById('description');
            if (this.value !== 'Custom') {
                document.getElementById('jobName').value = this.value;
                const template = jobTemplates[this.value];
                if (template && template.steps) {
                    // Brief description: Join first 5 steps with newlines for readability
                    const briefSteps = template.steps.slice(0, 5).join('\n- ');
                    descTextarea.value = `- ${briefSteps}`;
                }
            } else {
                // Clear description for Custom
                descTextarea.value = '';
            }
        });

        document.getElementById('actionButton').onclick = () => {
            const idx = +document.getElementById('editIndex').value;
            const date = document.getElementById('sessionDate').value;
            let job = document.getElementById('jobName').value.trim();
            const addr = document.getElementById('address').value.trim();
            const tIn = document.getElementById('timeIn').value;
            const tOut = document.getElementById('timeOut').value;
            const desc = document.getElementById('description').value.trim();

            if (!date) return alert('Select a date');
            if (!job) return alert('Enter job name');
            if (timeToDecimal(tOut) === timeToDecimal(tIn)) return alert('Time In and Time Out cannot be the same');

            const entry = {dateStr: date, jobName: job, address: addr, timeIn: tIn, timeOut: tOut, description: desc};

            if (idx === -1) entries.push(entry);
            else entries[idx] = entry;

            });

            // Totals
            const finalY = doc.lastAutoTable.finalY + 10;
            const subtotal = Array.from(invoiceItems.querySelectorAll('.amount')).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2);
            const hst = (parseFloat(subtotal) * 0.13).toFixed(2);
            const total = (parseFloat(subtotal) + parseFloat(hst)).toFixed(2);
            doc.text("HST: $" + hst, 150, finalY);
            doc.text("TOTAL: $" + total, 150, finalY + 10);

            // Footer
            doc.setFontSize(8);
            doc.text("e-transfer accepted at Jason@archerser.ca", 105, 280, {align: 'center'});

            const filename = document.getElementById('clientName').value || 'Invoice';
            doc.save(`${filename}_${formatDate(document.getElementById('sessionDate').value)}.pdf`);

            // Save new tasks with category
            invoiceItems.querySelectorAll('.invoice-line').forEach(line => {
                const category = line.querySelector('.category').value;
                const task = line.querySelector('.desc').value.trim();
                if (task && !taskHistory.some(t => t.category === category && t.task === task)) {
                    taskHistory.push({category, task});
                    if (taskHistory.length > 100) taskHistory.shift();
                }
            });
            saveData();

            invoiceModal.style.display = 'none';
            document.getElementById('loading').style.display = 'none';
        };

        // Ctrl+Enter shortcut
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter')
                document.getElementById('actionButton').click();
        });

        // Init
        loadData();
        clearForm();
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
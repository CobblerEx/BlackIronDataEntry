<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#2c3e50 100%);color:#e0e0e0;padding:1.5rem;margin:0;}
        .nav-buttons {display:flex;justify-content:center;gap:1rem;margin:1rem 0;flex-wrap:wrap;}
        .nav-button {width:40px;height:40px;background:#2a2a2a;border:2px solid #ff4500;border-radius:50%;color:#ff4500;display:flex;align-items:center;justify-content:center;text-decoration:none;position:relative;}
        .nav-button:hover {transform:scale(1.1);box-shadow:0 0 15px rgba(255,69,0,.8);}
        .nav-button::after {content:attr(data-tooltip);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#ff4500;color:#fff;padding:5px 10px;border-radius:4px;font-size:.8rem;opacity:0;white-space:nowrap;transition:opacity .2s;pointer-events:none;z-index:10;}
        .nav-button:hover::after {opacity:1;}
        h1,h2 {color:#ff4500;text-align:center;text-shadow:0 0 10px rgba(255,69,0,.5);}
        #form,#totalTime {background:rgba(30,30,30,.95);padding:1.5rem;border-radius:10px;box-shadow:0 0 20px rgba(255,69,0,.3);margin-bottom:1.5rem;}
        label {display:block;margin-bottom:.8rem;position:relative;}
        input,select,textarea {width:100%;padding:.7rem;background:#2a2a2a;color:#e0e0e0;border:1px solid #ff4500;border-radius:6px;font-size:1rem;box-sizing:border-box;}
        input:focus,select:focus,textarea:focus {outline:none;box-shadow:0 0 10px rgba(255,69,0,.7);}
        textarea {height:80px;resize:vertical;}
        button {background:#ff4500;color:white;border:none;padding:.8rem 1.5rem;border-radius:6px;cursor:pointer;font-size:1rem;margin:0 .5rem .5rem 0;transition:all .2s;}
        button:hover {transform:scale(1.05);box-shadow:0 0 15px rgba(255,69,0,.8);}
        #cancelButton,#clearAllButton {background:#dc3545;}
        #copyLast {background:#28a745;}
        #address {padding-right:50px !important;}
        .history-btn {position:absolute;right:8px;top:38px;background:#ff4500;color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;}
        #addressHistory {display:none;position:absolute;top:100%;left:0;right:0;background:#2a2a2a;border:1px solid #ff4500;border-radius:8px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 8px 20px rgba(0,0,0,.5);}
        .history-item {padding:12px 16px;cursor:pointer;border-bottom:1px solid #444;}
        .history-item:hover {background:#ff4500;color:white;padding-left:24px;}
        table {width:100%;border-collapse:collapse;background:rgba(30,30,30,.95);border-radius:10px;overflow:hidden;box-shadow:0 0 20px rgba(255,69,0,.3);margin:1rem 0;}
        th,td {border:1px solid #ff4500;padding:.6rem;text-align:left;}
        th {background:#ff4500;color:white;position:sticky;top:0;}
        tbody tr:hover {background:#333;transform:translateY(-2px);}
        .drag-handle {cursor:move;color:#ff4500;margin-right:8px;}
        .action-select {padding:6px;background:#2a2a2a;color:#e0e0e0;border:1px solid #ff4500;border-radius:4px;}
        #totalTime {font-size:1.4rem;font-weight:bold;text-align:center;padding:1rem;}
        #loading {display:none;text-align:center;padding:1.5rem;background:rgba(0,0,0,.8);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:10px;z-index:1000;}
        .spinner {border:5px solid #333;border-top:5px solid #ff4500;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;display:inline-block;}
        @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        @media (max-width:600px) {table{display:block;overflow-x:auto;white-space:nowrap;}}
    </style>
</head>
<body>
    <div class="nav-buttons">
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit.html" class="nav-button" data-tooltip="Black Iron Edit"><i class="fas fa-edit"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit3.html" class="nav-button" data-tooltip="Black Iron v1"><i class="fas fa-file-alt"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironcal2.html" class="nav-button" data-tooltip="Calculator"><i class="fas fa-calculator"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Uploadcsv.html" class="nav-button" data-tooltip="Upload CSV"><i class="fas fa-upload"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Timesheet.html" class="nav-button" data-tooltip="Timesheet"><i class="fas fa-clock"></i></a>
    </div>

    <h1>Timesheet Creator</h1>

    <div id="form">
        <label>Employee Name: <input type="text" id="employee" value="Lucas"></label>
        <label>Date: <input type="date" id="sessionDate"></label>
        <h2>Add / Edit Job Entry</h2>
        
        <label>Job Name: <input type="text" id="jobName" placeholder="e.g. Furnace Tune-Up"></label>
        
        <label>Job Type (optional auto-description):
            <select id="jobType">
                <option value="">-- Select to auto-fill description --</option>
                <option value="Furnace Tune-Up">Furnace Tune-Up</option>
                <option value="AC Maintenance">Air Conditioner Maintenance</option>
                <option value="Gas Line Install">Gas Line Installation</option>
                <option value="Water Heater Service">Water Heater Service</option>
                <option value="Duct Cleaning">Duct Cleaning</option>
                <option value="Compressor Replacement">Compressor Replacement</option>
                <option value="Pool Heater Install">Pool Heater Gas Line / Install</option>
                <option value="Underground Gas Line">Underground Gas Line</option>
                <option value="General Service Call">General Service Call</option>
            </select>
        </label>

                <label style="position:relative;">
            Address: 
            <input type="text" id="address" placeholder="Type to search history..." autocomplete="off">
            <button type="button" class="history-btn" id="historyBtn"><i class="fas fa-history"></i></button>
            <div id="addressHistory"></div>
        </label>

        <label>Time In: <select id="timeIn"></select></label>
        <label>Time Out: <select id="timeOut"></select></label>
        
       <label>Description: <textarea id="description" placeholder="Auto-filled if Job Type selected. You can edit."></textarea></label>
        
        <input type="hidden" id="editIndex" value="-1">
        <div style="margin-top:1rem;">
            <button id="actionButton">Add Entry</button>
            <button id="copyLast">Copy Last Job</button>
            <button id="cancelButton" style="display:none;">Cancel Edit</button>
        </div>
    </div>

    <div id="totalTime">Total Time: 0 hrs 0 min</div>

    <table id="entriesTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Job / Address</th>
                <th>Time In</th>
                <th>Time Out</th>
                <th>Hours</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="text-align:center;margin:2rem 0;">
        <button id="generateExcel">Generate Excel</button>
        <button id="generateInvoice">Generate Invoice</button>
        <button id="clearAllButton">Clear All</button>
    </div>

    <div id="loading"><div class="spinner"></div><br>Generating...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
            // === JOB TYPE AUTO-DESCRIPTION TEMPLATES ===
        const jobTemplates = {
            "Furnace Tune-Up": "Inspected and cleaned furnace components including burner, heat exchanger, and blower. Checked thermostat operation, gas pressure, ignition system, and safety controls. Replaced air filter. Tested system for proper operation and carbon monoxide levels.",
            "AC Maintenance": "Performed seasonal maintenance on air conditioning system: cleaned condenser coils, checked refrigerant levels, inspected electrical components, lubricated moving parts, cleared drain line, and tested system performance.",
            "Gas Line Install": "Installed new black iron gas piping from meter to appliance location. Pressure tested line to 15 PSI for 15 minutes with no drop. Installed drip leg, shut-off valve, and sediment trap per code requirements.",
            "Water Heater Service": "Flushed water heater tank, inspected anode rod, tested temperature & pressure relief valve, checked burner assembly (gas) or heating elements (electric), and verified proper venting.",
            "Duct Cleaning": "Performed complete duct cleaning using rotary brush and HEPA vacuum system. Removed and cleaned all supply and return vents. Sanitized ductwork and applied microbial treatment where required.",
            "Compressor Replacement": "Recovered refrigerant, removed failed compressor, installed new compressor with compatible oil charge. Replaced filter drier, brazed connections, evacuated system to 500 microns, and recharged to manufacturer specifications.",
            "Pool Heater Install": "Installed new natural gas pool heater including gas line extension, electrical connection, bonding, and venting. Performed startup and verified proper operation.",
            "Underground Gas Line": "Installed underground polyethylene gas line from meter to building entrance. Trenched, bedded with sand, installed tracer wire, riser, and transition fitting. Pressure tested per local code.",
            "General Service Call": "Responded to customer service call. Diagnosed issue, performed necessary repairs/adjustments, and verified proper operation of equipment."
        };

        // === 12-HOUR TIME WITH AM/PM ===
        const timeOptions = [];
        for (let h = 0; h < 24; h++) {
            for (let m of [0, 30]) {
                const mil = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                const hr12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
                const period = h < 12 ? 'AM' : 'PM';
                const display = `${hr12}:${m.toString().padStart(2,'0')} ${period}`;
                timeOptions.push({mil, display});
            }
        }

        // Populate dropdowns
        const timeIn = document.getElementById('timeIn');
        const timeOut = document.getElementById('timeOut');
        timeOptions.forEach(o => {
            const opt1 = new Option(o.display, o.mil);
            const opt2 = opt1.cloneNode(true);
            timeIn.add(opt1);
            timeOut.add(opt2);
        });
        timeIn.value = '08:00';
        timeOut.value = '08:30';
        document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];

      // Auto-description on Job Type change
        document.getElementById('jobType').addEventListener('change', function() {
            const selected = this.value;
            const descField = document.getElementById('description');
            if (selected && jobTemplates[selected]) {
                descField.value = jobTemplates[selected];
                // Optionally auto-set Job Name if it's empty
                if (!document.getElementById('jobName').value.trim()) {
                    document.getElementById('jobName').value = selected;
                }
            }
        });

        // Convert 24h â†’ 12h display
        function to12hr(time24) {
            const opt = timeOptions.find(o => o.mil === time24);
            return opt ? opt.display : time24;
        }

        // Convert hours to decimal (still uses 24h internally)
        function timeToDecimal(t) {
            const [h, m] = t.split(':').map(Number);
            return h + m/60;
        }

        function decimalToHM(dec) {
            const totalMins = Math.round(dec * 60);
            return {h: Math.floor(totalMins / 60), m: totalMins % 60};
        }

        function formatHours(dec) {
            const {h, m} = decimalToHM(dec);
            return `${h}:${m.toString().padStart(2,'0')}`;
        }

        function getNextTime(current24) {
            const idx = timeOptions.findIndex(o => o.mil === current24);
            return timeOptions[(idx + 1) % timeOptions.length].mil;
        }

        function formatDate(d) {
            if (!d) return '';
            const [y, m, day] = d.split('-');
            return `${m}/${day}/${y}`;
        }

        // === DATA & STORAGE ===
        let entries = [];
        let addressHistory = JSON.parse(localStorage.getItem('addressHistory') || '[]');

        function saveData() {
            const data = {
                employee: document.getElementById('employee').value,
                date: document.getElementById('sessionDate').value,
                entries
            };
            localStorage.setItem('timesheetData', JSON.stringify(data));
            localStorage.setItem('addressHistory', JSON.stringify(addressHistory));
        }

        function loadData() {
            const saved = localStorage.getItem('timesheetData');
            if (saved) {
                const d = JSON.parse(saved);
                document.getElementById('employee').value = d.employee || 'Lucas';
                document.getElementById('sessionDate').value = d.date || new Date().toISOString().split('T')[0];
                entries = d.entries || [];
            }
            renderTable();
        }

        // === ADDRESS HISTORY ===
        const addrInput = document.getElementById('address');
        const dropdown = document.getElementById('addressHistory');
        function showHistory(filter = '') {
            dropdown.innerHTML = '';
            const list = filter 
                ? addressHistory.filter(a => a.toLowerCase().includes(filter.toLowerCase()))
                : addressHistory;
            if (list.length === 0) {
                dropdown.innerHTML = '<div class="history-item">No addresses found</div>';
            } else {
                list.forEach(a => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = a;
                    div.onclick = () => { addrInput.value = a; dropdown.style.display = 'none'; };
                    dropdown.appendChild(div);
                });
            }
            dropdown.style.display = 'block';
        }
        addrInput.addEventListener('input', () => showHistory(addrInput.value));
        addrInput.addEventListener('focus', () => showHistory());
        document.getElementById('historyBtn').onclick = () => showHistory();
        document.addEventListener('click', e => {
            if (!addrInput.contains(e.target) && !document.getElementById('historyBtn').contains(e.target) && !dropdown.contains(e.target))
                dropdown.style.display = 'none';
        });

        // === RENDER TABLE ===
        function renderTable() {
            const tbody = document.querySelector('#entriesTable tbody');
            tbody.innerHTML = '';
            let totalDec = 0;

            entries.forEach((e, i) => {
                const inDec = timeToDecimal(e.timeIn);
                const outDec = timeToDecimal(e.timeOut);
                const duration = outDec >= inDec ? outDec - inDec : outDec - inDec + 24;
                totalDec += duration;

                const tr = document.createElement('tr');
                tr.draggable = true;
                tr.dataset.index = i;
                tr.innerHTML = `
                    <td>${formatDate(e.dateStr)}</td>
                    <td><strong>${e.jobName}</strong><br><small>${e.address || ''}</small></td>
                    <td>${to12hr(e.timeIn)}</td>
                    <td>${to12hr(e.timeOut)}</td>
                    <td>${formatHours(duration)}</td>
                    <td>${e.description || ''}</td>
                    <td>
                        <i class="fas fa-grip-lines drag-handle"></i>
                        <select class="action-select">
                            <option value="" disabled selected>Actions</option>
                            <option value="edit">Edit</option>
                            <option value="up">Up</option>
                            <option value="down">Down</option>
                            <option value="delete">Delete</option>
                        </select>
                    </td>`;
                tbody.appendChild(tr);
            });

            const {h, m} = decimalToHM(totalDec);
            document.getElementById('totalTime').textContent = `Total Time: ${h} hrs ${m} min`;

            // Drag & drop
            document.querySelectorAll('tr[data-index]').forEach(tr => {
                tr.addEventListener('dragstart', e => { tr.classList.add('dragging'); e.dataTransfer.setData('text', tr.dataset.index); });
                tr.addEventListener('dragover', e => e.preventDefault());
                tr.addEventListener('drop', e => {
                    e.preventDefault();
                    const from = +e.dataTransfer.getData('text');
                    const to = +tr.dataset.index;
                    if (from !== to) { const [item] = entries.splice(from,1); entries.splice(to,0,item); renderTable(); }
                });
                tr.addEventListener('dragend', () => tr.classList.remove('dragging'));
            });

            // Add JS event listeners for action-select dropdowns
            document.querySelectorAll('.action-select').forEach((select, idx) => {
                select.addEventListener('change', function() {
                    handleAction(idx, this.value);
                    this.value = '';
                });
            });

            saveData();
        }

        // === ACTIONS ===
        function handleAction(i, act) {
            if (act === 'edit') {
                const e = entries[i];
                document.getElementById('jobName').value = e.jobName;
                document.getElementById('address').value = e.address || '';
                document.getElementById('timeIn').value = e.timeIn;
                document.getElementById('timeOut').value = e.timeOut;
                document.getElementById('description').value = e.description || '';
                document.getElementById('jobType').value = ''; // don't pre-select
                document.getElementById('editIndex').value = i;
                document.getElementById('actionButton').textContent = 'Update Entry';
                document.getElementById('cancelButton').style.display = 'inline-block';
                document.getElementById('form').scrollIntoView({behavior:'smooth'});
            }
            else if (act === 'up' && i > 0) { [entries[i-1], entries[i]] = [entries[i], entries[i-1]]; renderTable(); }
            else if (act === 'down' && i < entries.length-1) { [entries[i], entries[i+1]] = [entries[i+1], entries[i]]; renderTable(); }
            else if (act === 'delete' && confirm('Delete this entry?')) { entries.splice(i,1); renderTable(); }
        }

        // === FORM ===
        document.getElementById('actionButton').onclick = () => {
            const idx = +document.getElementById('editIndex').value;
            const date = document.getElementById('sessionDate').value;
            const job = document.getElementById('jobName').value.trim();
            const addr = document.getElementById('address').value.trim();
            const tIn = document.getElementById('timeIn').value;
            const tOut = document.getElementById('timeOut').value;
            const desc = document.getElementById('description').value.trim();

            if (!date) return alert('Select a date');
            if (!job) return alert('Enter job name');
            if (timeToDecimal(tOut) === timeToDecimal(tIn)) return alert('Time In and Time Out cannot be the same');

            const entry = {dateStr: date, jobName: job, address: addr, timeIn: tIn, timeOut: tOut, description: desc};

            if (idx === -1) entries.push(entry);
            else entries[idx] = entry;

            if (addr && !addressHistory.includes(addr)) {
                addressHistory.unshift(addr);
                if (addressHistory.length > 50) addressHistory.pop();
            }

            renderTable();
            clearForm();
        };

        function clearForm() {
            document.getElementById('jobName').value = '';
            document.getElementById('jobType').value = '';
            document.getElementById('address').value = '';
            document.getElementById('description').value = '';
            document.getElementById('editIndex').value = -1;
            document.getElementById('actionButton').textContent = 'Add Entry';
            document.getElementById('cancelButton').style.display = 'none';
            if (entries.length) {
                const last = entries[entries.length-1];
                document.getElementById('timeIn').value = last.timeOut;
                document.getElementById('timeOut').value = getNextTime(last.timeOut);
            }
                    document.getElementById('jobName').focus();
        }
        document.getElementById('cancelButton').onclick = clearForm;

        document.getElementById('copyLast').onclick = () => {
            if (!entries.length) return alert('No previous job');
            const l = entries[entries.length-1];
            document.getElementById('jobName').value = l.jobName;
            document.getElementById('address').value = l.address || '';
            document.getElementById('description').value = l.description || '';
            document.getElementById('timeIn').value = l.timeOut;
            document.getElementById('timeOut').value = getNextTime(l.timeOut);
            document.getElementById('jobType').value = '';
        };

        document.getElementById('clearAllButton').onclick = () => {
            if (confirm('Clear ALL entries?')) { entries = []; renderTable(); clearForm(); }
        };

        // === EXCEL EXPORT (12-hour format) ===
        document.getElementById('generateExcel').onclick = () => {
            document.getElementById('loading').style.display = 'block';
            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    const data = [
                        [`Timesheet - ${document.getElementById('employee').value}`, `Date: ${formatDate(document.getElementById('sessionDate').value)}`],
                        [], 
                        ['Job Name', 'Address', 'Time In', 'Time Out', 'Hours', 'Description']
                    ];
                    let totalDec = 0;
                    entries.forEach(e => {
                        const dur = timeToDecimal(e.timeOut) >= timeToDecimal(e.timeIn) 
                            ? timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn)
                            : timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn) + 24;
                        totalDec += dur;
                        data.push([e.jobName, e.address || '', to12hr(e.timeIn), to12hr(e.timeOut), formatHours(dur), e.description || '']);
                    });
                    const {h, m} = decimalToHM(totalDec);
                    data.push([]); data.push(['TOTAL', '', '', '', `${h}:${m.toString().padStart(2,'0')}`, '']);
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch:20},{wch:30},{wch:14},{wch:14},{wch:10},{wch:40}];
                    XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
                    XLSX.writeFile(wb, `${document.getElementById('employee').value}_Timesheet_${document.getElementById('sessionDate').value}.xlsx`);
                } catch(e) {alert('Export failed')}
                document.getElementById('loading').style.display = 'none';
            }, 100);
        };

        // === GENERATE INVOICE AS PDF ===
        document.getElementById('generateInvoice').onclick = () => {
            document.getElementById('loading').textContent = 'Generating Invoice...'; // Update loading text
            document.getElementById('loading').style.display = 'block';

            const hourlyRate = prompt('Enter hourly rate (e.g., 50 for $50/hr):', '50');
            if (!hourlyRate || isNaN(hourlyRate)) {
                document.getElementById('loading').style.display = 'none';
                return alert('Invalid hourly rate');
            }
            const rate = parseFloat(hourlyRate);
            const hstRate = 0.13;

            const clientName = prompt('Enter client name:', '');
            const clientPhone = prompt('Enter client phone:', '');
            const clientEmail = prompt('Enter client email:', '');
            const clientAddress = prompt('Enter client address:', '');

            let totalHours = 0;
            const lines = entries.map(e => {
                const dur = timeToDecimal(e.timeOut) >= timeToDecimal(e.timeIn) 
                    ? timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn)
                    : timeToDecimal(e.timeOut) - timeToDecimal(e.timeIn) + 24;
                totalHours += dur;
                const amount = (dur * rate).toFixed(2);
                const desc = `${e.jobName} at ${e.address || 'N/A'} (${to12hr(e.timeIn)} - ${to12hr(e.timeOut)}): ${e.description || ''}`;
                return {quantity: dur.toFixed(2), desc, price: rate.toFixed(2), unit: 'hr', amount};
            });

            const subtotal = (totalHours * rate).toFixed(2);
            const hst = (parseFloat(subtotal) * hstRate).toFixed(2);
            const total = (parseFloat(subtotal) + parseFloat(hst)).toFixed(2);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Logo (simple text simulation, add image if you have URL/base64)
            doc.setFontSize(40);
            doc.text("A", 10, 20);
            doc.setFontSize(20);
            doc.text("ARCHER'S EQUIPMENT REPAIR", 10, 30);

            // Company info
            doc.setFontSize(10);
            doc.text("Archer's Equipment Repair Ltd.", 140, 10);
            doc.text("TSSA #/ 000394614", 140, 15);
            doc.text("HST #: 900518869RT0001", 140, 20);
            doc.text("Phone Number: 519-383-9654", 140, 25);

            // Invoice title
            doc.setFontSize(20);
            doc.text("INVOICE", 170, 30);

            // Client fields
            doc.setFontSize(12);
            doc.text("DATE: " + formatDate(document.getElementById('sessionDate').value), 10, 40);
            doc.text("NAME: " + clientName, 10, 50);
            doc.text("PHONE: " + clientPhone, 10, 60);
            doc.text("EMAIL: " + clientEmail, 10, 70);
            doc.text("ADDRESS: " + clientAddress, 10, 80);

            // Table headers
            doc.autoTable({
                startY: 90,
                head: [['QUANTITY', 'DESCRIPTION', 'PRICE', 'UNIT', 'AMOUNT']],
                body: lines.map(l => [l.quantity, l.desc, '$' + l.price, l.unit, '$' + l.amount]),
                theme: 'grid',
                headStyles: {fillColor: [211, 211, 211], textColor: [0, 0, 0]},
                styles: {cellPadding: 5, fontSize: 10, overflow: 'linebreak'},
                columnStyles: {1: {cellWidth: 80}},
            });

            // Totals
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text("HST: $" + hst, 150, finalY);
            doc.text("TOTAL: $" + total, 150, finalY + 10);

            // Footer
            doc.setFontSize(8);
            doc.text("e-transfer accepted at Jason@archerser.ca", 105, 280, {align: 'center'});

            doc.save(`${clientName || 'Client'}_Invoice_${document.getElementById('sessionDate').value}.pdf`);

            document.getElementById('loading').style.display = 'none';
        };

        // Ctrl+Enter shortcut
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter')
                document.getElementById('actionButton').click();
        });

        // Init
        loadData();
        clearForm();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timesheet Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {font-family:'Roboto',sans-serif;background:linear-gradient(135deg,#1a1a1a 0%,#2c3e50 100%);color:#e0e0e0;padding:1.5rem;margin:0;}
        .nav-buttons {display:flex;justify-content:center;gap:1rem;margin:1rem 0;flex-wrap:wrap;}
        .nav-button {width:40px;height:40px;background:#2a2a2a;border:2px solid #ff4500;border-radius:50%;color:#ff4500;display:flex;align-items:center;justify-content:center;text-decoration:none;position:relative;}
        .nav-button:hover {transform:scale(1.1);box-shadow:0 0 15px rgba(255,69,0,.8);}
        .nav-button::after {content:attr(data-tooltip);position:absolute;top:100%;left:50%;transform:translateX(-50%);background:#ff4500;color:#fff;padding:5px 10px;border-radius:4px;font-size:.8rem;opacity:0;white-space:nowrap;transition:opacity .2s;pointer-events:none;z-index:10;}
        .nav-button:hover::after {opacity:1;}
        h1,h2 {color:#ff4500;text-align:center;text-shadow:0 0 10px rgba(255,69,0,.5);}
        #form,#totalTime {background:rgba(30,30,30,.95);padding:1.5rem;border-radius:10px;box-shadow:0 0 20px rgba(255,69,0,.3);margin-bottom:1.5rem;}
        label {display:block;margin-bottom:.8rem;position:relative;}
        input,select,textarea {width:100%;padding:.7rem;background:#2a2a2a;color:#e0e0e0;border:1px solid #ff4500;border-radius:6px;font-size:1rem;box-sizing:border-box;}
        input:focus,select:focus,textarea:focus {outline:none;box-shadow:0 0 10px rgba(255,69,0,.7);}
        textarea {height:80px;resize:vertical;}
        button {background:#ff4500;color:white;border:none;padding:.8rem 1.5rem;border-radius:6px;cursor:pointer;font-size:1rem;margin:0 .5rem .5rem 0;transition:all .2s;}
        button:hover {transform:scale(1.05);box-shadow:0 0 15px rgba(255,69,0,.8);}
        #cancelButton,#clearAllButton {background:#dc3545;}
        #copyLast {background:#28a745;}
        #address {padding-right:50px !important;}
        .history-btn {position:absolute;right:8px;top:38px;background:#ff4500;color:white;border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;}
        #addressHistory {display:none;position:absolute;top:100%;left:0;right:0;background:#2a2a2a;border:1px solid #ff4500;border-radius:8px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 8px 20px rgba(0,0,0,.5);}
        .history-item {padding:12px 16px;cursor:pointer;border-bottom:1px solid #444;}
        .history-item:hover {background:#ff4500;color:white;padding-left:24px;}
        table {width:100%;border-collapse:collapse;background:rgba(30,30,30,.95);border-radius:10px;overflow:hidden;box-shadow:0 0 20px rgba(255,69,0,.3);margin:1rem 0;}
        th,td {border:1px solid #ff4500;padding:.6rem;text-align:left;}
        th {background:#ff4500;color:white;position:sticky;top:0;}
        tbody tr:hover {background:#333;transform:translateY(-2px);}
        .drag-handle {cursor:move;color:#ff4500;margin-right:8px;}
        .action-select {padding:6px;background:#2a2a2a;color:#e0e0e0;border:1px solid #ff4500;border-radius:4px;}
        #totalTime {font-size:1.4rem;font-weight:bold;text-align:center;padding:1rem;}
        #loading {display:none;text-align:center;padding:1.5rem;background:rgba(0,0,0,.8);position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);border-radius:10px;z-index:1000;}
        .spinner {border:5px solid #333;border-top:5px solid #ff4500;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;display:inline-block;}
        @keyframes spin {0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        @media (max-width:600px) {table{display:block;overflow-x:auto;white-space:nowrap;}}
    </style>
</head>
<body>
    <div class="nav-buttons">
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit.html" class="nav-button" data-tooltip="Black Iron Edit"><i class="fas fa-edit"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironwithedit3.html" class="nav-button" data-tooltip="Black Iron v1"><i class="fas fa-file-alt"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Blackironcal2.html" class="nav-button" data-tooltip="Calculator"><i class="fas fa-calculator"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Uploadcsv.html" class="nav-button" data-tooltip="Upload CSV"><i class="fas fa-upload"></i></a>
        <a href="https://cobblerex.github.io/BlackIronDataEntry/Timesheet.html" class="nav-button" data-tooltip="Timesheet"><i class="fas fa-clock"></i></a>
    </div>

    <h1>Timesheet Creator</h1>

    <div id="form">
        <label>Employee Name: <input type="text" id="employee" value="Lucas"></label>
        <label>Date: <input type="date" id="sessionDate"></label>
        <h2>Add / Edit Job Entry</h2>
        <label>Job Name: <input type="text" id="jobName"></label>
        <label style="position:relative;">
            Address: 
            <input type="text" id="address" placeholder="Type to search history..." autocomplete="off">
            <button type="button" class="history-btn" id="historyBtn"><i class="fas fa-history"></i></button>
            <div id="addressHistory"></div>
        </label>
        <label>Time In: <select id="timeIn"></select></label>
        <label>Time Out: <select id="timeOut"></select></label>
        <label>Description: <textarea id="description"></textarea></label>
        <input type="hidden" id="editIndex" value="-1">
        <div style="margin-top:1rem;">
            <button id="actionButton">Add Entry</button>
            <button id="copyLast">Copy Last Job</button>
            <button id="cancelButton" style="display:none;">Cancel Edit</button>
        </div>
    </div>

    <div id="totalTime">Total Time: 0 hrs 0 min</div>

    <table id="entriesTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Job / Address</th>
                <th>In</th>
                <th>Out</th>
                <th>Hours</th>
                <th>Description</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="text-align:center;margin:2rem 0;">
        <button id="generateExcel">Generate Excel</button>
        <button id="clearAllButton">Clear All</button>
    </div>

    <div id="loading"><div class="spinner"></div><br>Generating Excel...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // === TIME OPTIONS ===
        const timeOptions = [];
        for (let h = 0; h < 24; h++) {
            for (let m of [0, 30]) {
                const val = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                const h12 = h % 12 || 12;
                const period = h < 12 ? 'AM' : 'PM';
                timeOptions.push({value: val, text: `${h12}:${m.toString().padStart(2,'0')} ${period}`});
            }
        }
        document.getElementById('timeIn').innerHTML = timeOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
        document.getElementById('timeOut').innerHTML = document.getElementById('timeIn').innerHTML;
        document.getElementById('timeIn').value = '08:00';
        document.getElementById('timeOut').value = '08:30';
        document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];

        // === DATA ===
        let entries = [];
        let addressHistory = [];

        // === LOCAL STORAGE ===
        function loadData() {
            const saved = localStorage.getItem('timesheetData');
            if (saved) {
                const data = JSON.parse(saved);
                document.getElementById('employee').value = data.employee || 'Lucas';
                document.getElementById('sessionDate').value = data.date || new Date().toISOString().split('T')[0];
                entries = data.entries || [];
            }
            const hist = localStorage.getItem('addressHistory');
            if (hist) addressHistory = JSON.parse(hist);
            renderTable();
        }
        function saveData() {
            const data = {
                employee: document.getElementById('employee').value,
                date: document.getElementById('sessionDate').value,
                entries
            };
            localStorage.setItem('timesheetData', JSON.stringify(data));
        }
        function saveAddressHistory() {
            localStorage.setItem('addressHistory', JSON.stringify(addressHistory));
        }

        // === UTILS ===
        function timeToDecimal(t) {
            const [h, m] = t.split(':').map(Number);
            return h + m/60;
        }
        function decimalToHours(dec) {
            const totalMins = Math.round(dec * 60);
            const h = Math.floor(totalMins / 60);
            const m = totalMins % 60;
            return {h, m};
        }
        function formatHours(dec) {
            const {h, m} = decimalToHours(dec);
            return `${h}:${m.toString().padStart(2,'0')}`;
        }
        function getNextTime(current) {
            const idx = timeOptions.findIndex(o => o.value === current);
            return timeOptions[(idx + 1) % timeOptions.length].value;
        }

        // === ADDRESS HISTORY ===
        const addrInput = document.getElementById('address');
        const historyBtn = document.getElementById('historyBtn');
        const dropdown = document.getElementById('addressHistory');

        function showHistory(filter = '') {
            dropdown.innerHTML = '';
            const filtered = filter ? addressHistory.filter(a => a.toLowerCase().includes(filter.toLowerCase())) : addressHistory;
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="history-item">No addresses found</div>';
            } else {
                filtered.forEach(addr => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.textContent = addr;
                    div.onclick = () => {
                        addrInput.value = addr;
                        dropdown.style.display = 'none';
                    };
                    dropdown.appendChild(div);
                });
            }
            dropdown.style.display = 'block';
        }
        addrInput.addEventListener('input', () => showHistory(addrInput.value));
        addrInput.addEventListener('focus', () => showHistory());
        historyBtn.onclick = () => showHistory();
        document.addEventListener('click', e => {
            if (!addrInput.contains(e.target) && !historyBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        // === RENDER TABLE ===
        function renderTable() {
            const tbody = document.querySelector('#entriesTable tbody');
            tbody.innerHTML = '';
            let totalDecimal = 0;

            entries.forEach((entry, i) => {
                const inDec = timeToDecimal(entry.timeIn);
                const outDec = timeToDecimal(entry.timeOut);
                const duration = outDec >= inDec ? outDec - inDec : outDec - inDec + 24;
                totalDecimal += duration;

                const tr = document.createElement('tr');
                tr.draggable = true;
                tr.dataset.index = i;
                tr.innerHTML = `
                    <td>${entry.dateStr}</td>
                    <td><strong>${entry.jobName}</strong><br><small>${entry.address || ''}</small></td>
                    <td>${entry.timeIn}</td>
                    <td>${entry.timeOut}</td>
                    <td>${formatHours(duration)}</td>
                    <td>${entry.description || ''}</td>
                    <td>
                        <i class="fas fa-grip-lines drag-handle"></i>
                        <select class="action-select" onchange="handleAction(${i}, this.value); this.value=''">
                            <option value="" disabled selected>Actions</option>
                            <option value="edit">Edit</option>
                            <option value="up">Up</option>
                            <option value="down">Down</option>
                            <option value="delete">Delete</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Update total
            const {h, m} = decimalToHours(totalDecimal);
            document.getElementById('totalTime').textContent = `Total Time: ${h} hrs ${m} min`;

            // Drag & drop
            document.querySelectorAll('tr[data-index]').forEach(tr => {
                tr.addEventListener('dragstart', e => {
                    tr.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', tr.dataset.index);
                });
                tr.addEventListener('dragover', e => e.preventDefault());
                tr.addEventListener('drop', e => {
                    e.preventDefault();
                    const from = +e.dataTransfer.getData('text/plain');
                    const to = +tr.dataset.index;
                    if (from !== to) {
                        const [moved] = entries.splice(from, 1);
                        entries.splice(to, 0, moved);
                        renderTable();
                    }
                });
                tr.addEventListener('dragend', () => tr.classList.remove('dragging'));
            });

            saveData();
        }

        // === ACTIONS ===
        function handleAction(index, action) {
            if (action === 'edit') {
                const e = entries[index];
                document.getElementById('jobName').value = e.jobName;
                document.getElementById('address').value = e.address || '';
                document.getElementById('timeIn').value = e.timeIn;
                document.getElementById('timeOut').value = e.timeOut;
                document.getElementById('description').value = e.description || '';
                document.getElementById('editIndex').value = index;
                document.getElementById('actionButton').textContent = 'Update Entry';
                document.getElementById('cancelButton').style.display = 'inline-block';
                document.getElementById('form').scrollIntoView({behavior: 'smooth'});
            }
            else if (action === 'up' && index > 0) {
                [entries[index-1], entries[index]] = [entries[index], entries[index-1]];
                renderTable();
            }
            else if (action === 'down' && index < entries.length-1) {
                [entries[index], entries[index+1]] = [entries[index+1], entries[index]];
                renderTable();
            }
            else if (action === 'delete') {
                if (confirm('Delete this entry?')) {
                    entries.splice(index, 1);
                    renderTable();
                }
            }
        }

        // === FORM SUBMIT ===
        document.getElementById('actionButton').onclick = () => {
            const idx = +document.getElementById('editIndex').value;
            const date = document.getElementById('sessionDate').value;
            const job = document.getElementById('jobName').value.trim();
            const addr = document.getElementById('address').value.trim();
            const tIn = document.getElementById('timeIn').value;
            const tOut = document.getElementById('timeOut').value;
            const desc = document.getElementById('description').value.trim();

            if (!date) return alert('Select date');
            if (!job) return alert('Enter job name');
            if (timeToDecimal(tOut) <= timeToDecimal(tIn)) return alert('Time Out must be after Time In');

            const entry = {dateStr: date, jobName: job, address: addr, timeIn: tIn, timeOut: tOut, description: desc};

            if (idx === -1) {
                entries.push(entry);
            } else {
                entries[idx] = entry;
            }

            if (addr && !addressHistory.includes(addr)) {
                addressHistory.unshift(addr);
                if (addressHistory.length > 50) addressHistory.pop();
                saveAddressHistory();
            }

            renderTable();
            clearForm();
        };

        function clearForm() {
            document.getElementById('jobName').value = '';
            document.getElementById('address').value = '';
            document.getElementById('description').value = '';
            document.getElementById('editIndex').value = -1;
            document.getElementById('actionButton').textContent = 'Add Entry';
            document.getElementById('cancelButton').style.display = 'none';
            if (entries.length > 0) {
                const last = entries[entries.length-1];
                document.getElementById('timeIn').value = last.timeOut;
                document.getElementById('timeOut').value = getNextTime(last.timeOut);
            }
        }
        document.getElementById('cancelButton').onclick = clearForm;

        document.getElementById('copyLast').onclick = () => {
            if (entries.length === 0) return alert('No previous job');
            const last = entries[entries.length-1];
            document.getElementById('jobName').value = last.jobName;
            document.getElementById('address').value = last.address || '';
            document.getElementById('description').value = last.description || '';
            document.getElementById('timeIn').value = last.timeOut;
            document.getElementById('timeOut').value = getNextTime(last.timeOut);
        };

        document.getElementById('clearAllButton').onclick = () => {
            if (confirm('Clear ALL entries? This cannot be undone.')) {
                entries = [];
                renderTable();
                clearForm();
            }
        };

        // === EXCEL EXPORT ===
        document.getElementById('generateExcel').onclick = () => {
            document.getElementById('loading').style.display = 'block';
            setTimeout(() => {
                try {
                    const wb = XLSX.utils.book_new();
                    const data = [['Employee:', document.getElementById('employee').value], ['Date:', document.getElementById('sessionDate').value], [], ['Job', 'Address', 'Time In', 'Time Out', 'Hours', 'Description']];
                    
                    let totalDec = 0;
                    entries.forEach(e => {
                        const inDec = timeToDecimal(e.timeIn);
                        const outDec = timeToDecimal(e.timeOut);
                        const dur = outDec >= inDec ? outDec - inDec : outDec - inDec + 24;
                        totalDec += dur;
                        data.push([e.jobName, e.address || '', e.timeIn, e.timeOut, formatHours(dur), e.description || '']);
                    });
                    const {h, m} = decimalToHours(totalDec);
                    data.push([]); data.push(['TOTAL HOURS:', '', '', '', `${h}:${m.toString().padStart(2,'0')}`, '']);
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch:20}, {wch:30}, {wch:12}, {wch:12}, {wch:10}, {wch:40}];
                    XLSX.utils.book_append_sheet(wb, ws, 'Timesheet');
                    XLSX.writeFile(wb, `${document.getElementById('employee').value || 'Employee'}_Timesheet_${document.getElementById('sessionDate').value || 'Date'}.xlsx`);
                } catch (e) {alert('Export failed')}
                document.getElementById('loading').style.display = 'none';
            }, 100);
        };

        // Ctrl+Enter to save
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                document.getElementById('actionButton').click();
            }
        });

        // === INIT ===
        loadData();
        clearForm();
    </script>
</body>
</html>